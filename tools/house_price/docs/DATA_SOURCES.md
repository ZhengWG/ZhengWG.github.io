# 房价数据源说明

## 当前：聚汇数据 (gotohui)

- **城市 / 区域**：有完整历史月度与最新均价，来源稳定。
- **小区**：区级页可解析「小区 + 单价 + 环比」。
- **板块（之江/三墩/转塘等）**：聚汇区级页**没有**板块层级，只有「区域列表 + 小区列表」，无法解析出带 `fjdata-xxx` 的板块链接，因此**板块历史与板块均价均为空**。

结论：若需要板块级细分数据，必须**接入其他数据源**或**用现有小区数据聚合**。

---

## 当前板块数据来源：小区聚合（已生效）

**不依赖任何新 API**，用聚汇已有的「区 → 小区 + 均价」数据，按「板块关键词」映射聚合出板块均价：

1. **映射文件**：`data/sub_district_keywords.json`  
   按城市、区、板块名配置关键词（如西湖区下「之江」含关键词 之江/九溪/宋城等）。
2. **逻辑**：导出时对本区每个小区名做关键词匹配，命中某板块则把该小区均价计入该板块，最后按板块求平均，得到 `sub_districts[].price`（及 `yoy` 用环比近似）。
3. **效果**：重新执行 `python export_data.py -c hz` 后，西湖区、滨江区、余杭区等有配置关键词的区会得到**真实板块均价**，前端「选择区域查看板块走势」和「板块最新均价」会显示数据。

可随时编辑 `sub_district_keywords.json` 增补关键词以覆盖更多小区、或新增区/板块。

#### 用「小区 → 板块」精确映射定位板块（可选）

聚汇数据**没有**街道/板块字段，只能通过小区名推断。若希望更准确定位板块，可维护 **`data/community_to_sub_district.json`**：

- **格式**：按城市、区（config 里的 district key）、小区名 → 板块名。
- **示例**：
```json
{
  "hz": {
    "xihu": {
      "西溪路24号": "西溪",
      "丹金桂花园": "黄龙",
      "文星桥": "文教"
    }
  }
}
```
- **优先级**：若某小区在该文件中存在，则直接归入对应板块，不再用关键词匹配；未列出的仍走关键词。
- **如何获得映射**：贝壳 hz.ke.com 小区列表页（按区筛选）表格中有「板块」列，可手工或爬虫整理「小区名 → 板块名」后写入该文件；或从其它带板块的数据源导出。

---

## 获取更多小区房价信息的途径

在现有「聚汇区级 + house-{id} 分页」基础上，可从以下方向扩充小区数量与维度。

### 1. 挖尽当前聚汇数据

- **分页**：`scrapers/gotohui.py` 已从 `house-{区id}`、`house-{区id}/2.html` … 拉取小区（默认最多 30 页，每页约 20 条）。若某区小区很多，可适当提高 `max_pages`。
- **覆盖全部区**：确认 `config.py` 里要展示的区都配置了 `gotohui_id`，导出时会逐区请求 house 分页，小区列表合并进该区。
- **去重**：同一小区可能在不同页出现，导出逻辑按小区名去重即可（保留最新或第一条）。

### 2. 贝壳找房 (ke.com / 链家)

- **小区列表**：hz.ke.com 按区/板块有「小区」列表页，表格含小区名、板块、参考挂牌价等。
- **方式一**：[贝壳开放平台](https://open.ke.com/) 申请 API，查询小区列表、小区详情或成交数据，合规且稳定，需 token。
- **方式二**：爬取 hz.ke.com 小区列表或前端接口（如 XHR 返回的 JSON），可得到「小区 + 板块 + 价格」。需控制频率、遵守 robots 与法律。
- **用途**：既可作**第二数据源**（小区均价合并进本仓库），也可只用来生成「小区 → 板块」映射写入 `community_to_sub_district.json`，再用聚汇价格做板块聚合。

### 3. 云房数据 (yunfangdata.com)

- **接口**：提供「小区基础信息」等 API，输入城市 + 小区名可查均价、同比、环比等。
- **特点**：按小区查询，适合对聚汇已有小区名做**补全/校验**，或对聚汇没有的小区做**补充**。无板块字段，板块需自建映射。
- **申请**：见下文「如何申请 API Token」中的云房部分。

### 4. 房天下 (fang.com) / 安居客 (anjuke.com)

- **列表页**：城市/区/板块下常有「小区列表」或「在售房源」页，页面或接口中可解析出小区名、参考价。
- **方式**：多为前端渲染或接口需分析，需自行抓包解析；板块维度若页面有则一并解析，用于映射或聚合。
- **注意**：反爬与请求频率需自行把控，合规使用。

### 5. 诸葛找房 (zhuge.com) 等

- 同样有城市/区/板块下的小区与价格信息，可通过其 API（若有开放）或页面解析获取小区均价，再与现有数据合并或仅用于板块映射。

### 6. 多源合并思路（本仓库）

- **小区列表**：聚汇为主；若接入贝壳/云房等，可按「城市 + 区 + 小区名」合并，同小区多源时可选「聚汇优先」或「按时间取最新」。
- **板块**：优先用 `community_to_sub_district.json`（可从贝壳等带板块的数据源整理），再关键词匹配；板块均价用当前区下所有已归属小区价格聚合。
- **代码**：在 `export_data.py` 中，小区列表目前来自聚汇；若增加第二数据源，可在导出前合并 `communities` 列表并去重，再统一走现有板块聚合逻辑。

---

## 可选替代接口（补充用）

### 1. 贝壳找房 (ke.com)

- **特点**：房源与小区数据含「区 → 板块(bizcircle) → 小区」结构，适合做板块均价。
- **方式一**： [贝壳开放平台](https://open.ke.com/) 申请 API（小区/成交案例等），合规但需申请与 token。
- **方式二**：爬取 hz.ke.com 小区列表页或前端请求的接口，可得到「小区 + 板块 + 挂牌价」，再按板块聚合得到板块均价（注意反爬与请求间隔）。
- **本项目**：`scrapers/beike.py` 预留了贝壳板块数据接入，可按需实现并开启。

### 2. 云房数据 (yunfangdata.com)

- 提供**小区基础信息接口**（小区名 + 城市 → 均价、同比、环比、行政区）。
- 无直接「板块」接口，需自建「小区 → 板块」映射后，用小区均价聚合得到板块数据。
- 需申请 key / 签名，见 [云房数据 API](https://www.yunfangdata.com/dataapi.html)。

### 3. 中指云 (cih-index.com)

- 地产数据 API，含百城价格指数等，偏宏观；是否有城市内板块级需咨询与试用。

### 4. 房天下 / 安居客

- 多为房源详情或列表接口，板块维度需自行从页面或接口中解析并聚合。

---

## 如何申请 API Token

### 贝壳开放平台 (open.ke.com)

1. **打开平台**：<https://open.ke.com/>
2. **注册/登录**：右上角「登录」或「注册」。
3. **申请试用**：
   - 首页或侧边栏有「**申请试用**」入口；
   - 或进入具体产品（如「成交案例库」「房屋价值分析」）后点「申请试用」。
4. **选择类型**：
   - **个人试用**：一般即开即用；
   - **企业试用**：配额更高，需人工审核。
5. **获取 Token**：试用开通后，在「控制台」或对应产品页点击「**立即试用**」，按文档获取 `access_token` 等参数。
6. **文档与限制**：使用前阅读「技术文档」「使用教程」；请求间隔建议 ≥3 秒，遵守平台协议。

- Token 获取说明：<https://open.ke.com/serviceSupport/getToken/>

### 云房数据 (yunfangdata.com)

1. **打开 API 页**：<https://www.yunfangdata.com/dataapi.html>
2. **选接口**：如「小区基础信息接口」<https://www.yunfangdata.com/dataapi/api_031.html>
3. **申请试用**：页面内「**申请试用**」按钮，填写信息提交。
4. **拿到认证参数**：申请通过后会提供：
   - `key_id`（签名 ID）
   - `access_signature`（签名）
   - 请求时还需传 `time_stamp`（时间戳）。
5. **调用方式**：GET 请求，参数见各接口文档（如小区名、城市名 + 上述认证参数）。

---

## 推荐做法

- **仅要板块当前均价**：优先考虑贝壳（开放平台 API 或合规爬虫），按板块聚合小区挂牌价。
- **要板块历史走势**：需数据源本身提供板块维度历史，或长期抓取贝壳等并按板块聚合留存。
- **本仓库**：继续用聚汇做城市/区域/小区；板块数据通过 `scrapers/beike.py`（或后续云房等）补充，在 `export_data.py` 中合并进 `sub_districts` 的 `price` / `yoy`。
